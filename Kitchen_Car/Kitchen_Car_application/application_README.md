# 施設運営「キッチンカー」本申請システム

## 目次

1. [概要](#概要)
2. [目的](#目的)
3. [機能](#機能)
4. [設定](#設定)
5. [スクリプトの主な関数](#スクリプトの主な機能)
6. [ファイル構成](#ファイル構成)
7. [イメージ](#イメージ)

---

## 概要

本スクリプトはサークルが運営している施設「キッチンカー」の仮申請自動化システムに関して記したものである。

キッチンカーを利用するには、利用者へ施設の貸し出しが可能かを確認する「仮申請」と学校側へ提出する資料などを作成する「本申請」の二段階の申請が必要である。ここでは二段階目の「本申請」に関して記載する。(仮申請に関しては[こちら](/Kitchen_Car/Kitchen_Car_provisional_application/provisional_application_README.md))

本プロジェクトは、Google Apps Script を活用して、キッチンカー利用申請のプロセスを自動化するスクリプトです。Googleフォームから送信されたデータを基に、以下の一連のタスクを効率化しています：
- フォーム回答の解析と処理
- 申請書ドキュメントの自動生成
- スケジュール調整用スプレッドシートの作成
- Googleカレンダーへのイベント登録
- メール送信による通知およびフォローアップ


<p align="right">(<a href="#top">トップへ</a>)</p>

---

## 機能

### 1. **フォームのデータ取得**
- `onFormSubmit` 関数は、Googleフォームが送信された際にトリガーが作動する
- 送信された回答 (`e.values`) を取得し、申請日、代表者情報、サークル名、参加者情報などを変数に格納

### 2. **Googleカレンダーへのイベント登録**
- イベントの日程 (`start_date`, `end_date`, `start_time`, `end_time`) を基に、Googleカレンダーに新しいイベントを作成
- イベント名は「キッチンカー利用 - サークル名」として登録される
- カレンダーのイベントカラーを「ピンク（ID:4）」に設定している

### 3. **フォルダおよびファイル管理**
- ドライブ内に「親フォルダID」を基に、新しいフォルダを作成。フォルダ名は「サークル名_開始日付」に設定。
- テンプレートドキュメントをコピーし、新しいフォルダに保存。
- コピーされたドキュメントを編集し、フォームの回答内容を反映。

### 4. **画像の処理**
- フォームでアップロードされた写真をGoogleドライブから取得し、ドキュメントに挿入。
- 画像の縦横比を維持しながらサイズを調整（幅300px）して追加している。

### 5. **リマインド用のスプレッドシートへのデータ記録**
- リマインド用のGoogleスプレッドシート([参照](/Kitchen_Car/Kitchen_Car_reminder/reminder_README.md))に、申請情報を新しい行として追加。これによりリマインド処理が行えるようになる。
- 保存されるデータは以下の通り
  - サークル名
  - 利用開始日
  - 利用終了日
  - リンク（作成されたドキュメントやスプレッドシートのURL）
  - 連絡用メールアドレス
  - 代表者氏名
  - 施設利用日の2日前
  - 施設利用日の1週間前

### 7. **メール通知**
#### メール送信内容
1. **学校担当者への申請メール**
   - 生成されたPDFを添付し、申請情報を共有
   - 代表者情報をCCに含め、関係者間の情報共有を円滑にできるようにした
2. **持ち物リスト作成依頼メール**
   - 持ち物リストやスケジュールの調整を依頼する趣旨のメールを送信
   - 持ち物確認用の[Googleスプレッドシートリンク](/Kitchen_Car/Kitchen_Car_application/list_and_schedule.xlsx)を添付

### 8. **作成した資料をドライブに保存**
- 上記の操作でできた資料を新しく作成したフォルダに保存


<p align="right">(<a href="#top">トップへ</a>)</p>

---

## 設定

1. **Googleフォームの作成**
   - キッチンカー利用申請用のフォームを作成してください。

2. **Googleドライブの設定**
   - テンプレートドキュメントとスプレッドシートを用意し、それぞれのファイルIDをスクリプト内で指定します。

3. **Googleカレンダー**
   - カレンダーのデフォルト設定でイベントを作成します。

4. **スクリプトのトリガー**
   - フォーム送信時に`onFormSubmit`関数が実行されるようトリガーを設定してください。


---

## スクリプトの主な関数

### 1. **`onFormSubmit(e)`**
#### 概要
- Googleフォームが送信されたときにトリガーされるメインの関数
- フォームの回答を取得し、以下の一連のプロセスを実行

#### 主な処理
1. **フォーム回答の取得**
   - `e.values` を利用して回答データを取得
   - 各データ（代表者名、クラブ名、開始日、終了日など）を変数に格納

2. **Googleカレンダーへのイベント登録**
   - 回答データを基にカレンダーイベントを作成
   - 日時や利用概要を説明に追加し、イベントの色をピンクに設定

3. **Googleドキュメントの生成**
   - テンプレートドキュメントをコピーし、回答内容を埋め込む形で編集
   - 編集後、PDFとして変換し、Googleドライブの新しいフォルダに保存

4. **スプレッドシートへの記録**
   - 回答データをスプレッドシートの新しい行に記録
   - 記録するデータには、サークル名、利用日程、リンク情報、連絡先などが含まれる

5. **メール通知**
   - 学校担当者とサークル代表者に申請書の情報をメールで送信
   - 生成されたPDFを添付して共有

### 2. **`createFolderInParent(parentFolderId, newFolderName)`**
#### 概要
- 指定された親フォルダ内に新しいフォルダを作成するためのヘルパー関数

#### 主な処理
1. **フォルダ作成**
   - `DriveApp.getFolderById(parentFolderId)` を利用して親フォルダを取得
   - 指定されたフォルダ名 (`newFolderName`) で新しいフォルダを作成

2. **フォルダIDの返却**
   - 作成したフォルダのIDを返すことで、他の処理で利用可能にする

### 3. **`formatDate(date)`**
#### 概要
- `Date` オブジェクトを指定されたタイムゾーンでフォーマットするヘルパー関数

#### 主な処理
1. **日付フォーマット**
   - `Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd')` を利用して、日付を指定の形式 (`yyyy-MM-dd`) に変換

2. **フォーマット済みの日付を返却**
   - 他の処理（スプレッドシート記録やメール送信など）で利用可能


### 4. **`MailApp.sendEmail(options)`**
#### 概要
- メール通知を送信するための組み込み関数

#### 主な処理
1. **メール本文生成**
   - サークル名やリンク情報を挿入したカスタマイズされた本文を生成
   - メールの件名 (`subject`) や本文 (`body`) を指定

2. **PDF添付**
   - 生成されたPDFファイルを `attachments` パラメータで指定し、メールに添付

### 5. **`ImgApp.getSize(imageBlob)`**
#### 概要
- 画像の縦横比を取得し、ドキュメントへの画像挿入時にサイズを調整するためのヘルパー関数

#### 主な処理
1. **画像サイズ取得**
   - `DriveApp.getFileById` で取得した画像ファイルから Blob を取得
   - `ImgApp.getSize(blob)` で縦横のピクセルサイズを取得

2. **サイズ調整**
   - 横幅を 300px に設定し、アスペクト比を維持して高さを調整

### 6. **`Utilities.sleep(milliseconds)`**
#### 概要
- 処理間に一時停止を挟むための関数

#### 主な処理
1. **画像挿入のための時間を稼ぐ**
   - ドキュメントに画像を挿入するには時間がかかるため、10秒ほどスクリプトを寝かせておく



<p align="right">(<a href="#top">トップへ</a>)</p>

---

## ファイル構成

.

├── application_README.md                              # 本ファイル

├── [application.js](application.js)     # コード

├── [application_docs.pdf](application_docs.pdf)   # テンプレートドキュメント

├── [list_and_schedule.xlsx](list_and_schedule.xlsx)  # フォームの内容を反映させたスプレッドシート(出力の関係でExcelファイルになっている。本来はスプレッドシートのデータ)

└── [application_form.xlsx](application_form.xlsx)  # フォームの内容を反映させたスプレッドシート(出力の関係でExcelファイルになっている。本来はスプレッドシートのデータ)

<p align="right">(<a href="#top">トップへ</a>)</p>

---

## イメージ

- **Slack通知イメージ**: 準備中
- **デモ動画**: 準備中

---

<p align="right">(<a href="#top">トップへ</a>)</p>
